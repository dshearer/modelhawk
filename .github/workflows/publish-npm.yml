name: Publish to npm

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.2.3 without the v prefix)'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: v${{ inputs.version }}

      - uses: actions/setup-node@v4
        with:
          node-version: "25.5.0"
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'
          cache-dependency-path: gen/ts/package-lock.json

      - name: Verify version matches input
        run: |
          PACKAGE_VERSION=$(node -p "require('./gen/ts/package.json').version")
          INPUT_VERSION="${{ inputs.version }}"
          echo "Package version: $PACKAGE_VERSION"
          echo "Input version: $INPUT_VERSION"
          if [ "$PACKAGE_VERSION" != "$INPUT_VERSION" ]; then
            echo "::error::Version mismatch! gen/ts/package.json has $PACKAGE_VERSION but input version is $INPUT_VERSION"
            echo "::error::Update package-config/ts/package.json version to $INPUT_VERSION before publishing"
            exit 1
          fi

      - run: npm ci
        working-directory: gen/ts
      - run: npm run build --if-present
        working-directory: gen/ts
      - run: npm publish --provenance --access public
        working-directory: gen/ts
