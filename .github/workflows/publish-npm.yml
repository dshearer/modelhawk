name: Publish to npm

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "25.5.0"
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'
          cache-dependency-path: gen/ts/package-lock.json

      - name: Verify version matches release tag
        run: |
          PACKAGE_VERSION=$(node -p "require('./gen/ts/package.json').version")
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          echo "Package version: $PACKAGE_VERSION"
          echo "Tag version: $TAG_VERSION"
          if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::Version mismatch! gen/ts/package.json has $PACKAGE_VERSION but release tag is v$TAG_VERSION"
            echo "::error::Update package-config/ts/package.json version to $TAG_VERSION before creating the release"
            exit 1
          fi

      - name: Build and publish @dshearer/modelhawk
        working-directory: gen/ts
        run: |
          npm install
          npm run build
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: tag,
              generate_release_notes: true
            });
